name: Docker Build & Push

on:
  workflow_dispatch:  # Manual trigger only ✅
  # Remove workflow_run - causes artifact issues

jobs:
  docker:
    runs-on: ubuntu-latest
    name: Build & Push Docker Image

    steps:
    # 1️⃣ Checkout code
    - name: Checkout code
      uses: actions/checkout@v5

    # 2️⃣ Set up JDK (build JAR directly)
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'

    # 3️⃣ Build JAR (no artifact dependency)
    - name: Build JAR
      run: mvn clean package -DskipTests

    # 4️⃣ Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 5️⃣ Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 6️⃣ Debug: List target files
    - name: List JAR files
      run: ls -la target/

    # 7️⃣ Build & Push
    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        push: true
        tags: |
          ${{ vars.DOCKER_USERNAME }}/crypto-app:latest
          ${{ vars.DOCKER_USERNAME }}/crypto-app:3.0
