name: Docker Build & Push

on:
  workflow_run:
    workflows: ["Build & Test"]
    types: [completed]
  workflow_dispatch:

jobs:
  docker:
    runs-on: ubuntu-latest
    name: Build & Push Docker Image
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout code
      uses: actions/checkout@v5

    # 2️⃣ Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3️⃣ Log in to Docker Hub ✅ FIXED: Both secrets
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKER_USERNAME }}      # ← Both secrets
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 4️⃣ Download JAR artifact ✅ FIXED: Correct path
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: crypto-app-jar
        path: target/  # ← Matches Dockerfile COPY target/*.jar

    # 5️⃣ List files (debug)
    - name: List downloaded files
      run: ls -la target/

    # 6️⃣ Build & Push ✅ Multiple tags
    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        push: true
        tags: |
          ${{ vars.DOCKER_USERNAME }}/crypto-app:latest
          ${{ secrets.DOCKER_USERNAME }}/crypto-app:1.0
